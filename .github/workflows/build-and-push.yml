on:
 workflow_dispatch:
 push:
   branches:
     - main

jobs:
 build-generic:
   runs-on: ubuntu-latest
   steps:
     - name: Checkout
       uses: actions/checkout@v4

     - name: Set up Docker Buildx
       uses: docker/setup-buildx-action@v2

     - name: Log into Docker Hub
       uses: docker/login-action@v2
       with:
         username: ${{ secrets.DOCKERHUB_USERNAME }}
         password: ${{ secrets.DOCKERHUB_TOKEN }}

     - name: Install build bundler
       if: ${{ github.ref == 'refs/heads/main' }}
       run: |
         export VCS_REF=$(git rev-parse HEAD)
         npm install -g @devcontainers/cli

     - name: Build Generic
       if: ${{ github.ref == 'refs/heads/main' }}
       run: |
         devcontainer build \
           --workspace-folder ./devcontainers/generic/ \
             --image-name artbashkirev/codespace:generic-${{ github.sha }} \
             --image-name artbashkirev/codespace:generic \
             --image-name artbashkirev/codespace:latest

     - name: Push to Docker Hub
       if: ${{ github.ref == 'refs/heads/main' }}
       run: |
         docker push artbashkirev/codespace:generic-${{ github.sha }}
         docker push artbashkirev/codespace:generic
         docker push artbashkirev/codespace:latest

 build-ml:
   runs-on: ubuntu-latest
   steps:
     - name: Checkout
       uses: actions/checkout@v4

     - name: Set up Docker Buildx
       uses: docker/setup-buildx-action@v2

     - name: Log into Docker Hub
       uses: docker/login-action@v2
       with:
         username: ${{ secrets.DOCKERHUB_USERNAME }}
         password: ${{ secrets.DOCKERHUB_TOKEN }}

     - name: Install build bundler
       if: ${{ github.ref == 'refs/heads/main' }}
       run: |
         export VCS_REF=$(git rev-parse HEAD)
         npm install -g @devcontainers/cli

     - name: Build ML
       if: ${{ github.ref == 'refs/heads/main' }}
       run: |
         devcontainer build \
           --workspace-folder ./devcontainers/ml/ \
             --image-name artbashkirev/codespace:ml-${{ github.sha }} \
             --image-name artbashkirev/codespace:ml

     - name: Push to Docker Hub
       if: ${{ github.ref == 'refs/heads/main' }}
       run: |
         docker push artbashkirev/codespace:ml-${{ github.sha }}
         docker push artbashkirev/codespace:ml
